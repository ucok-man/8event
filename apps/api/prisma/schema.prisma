// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["views"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model PointBalance {
  id           String           @id @default(uuid())
  user         User             @relation(fields: [userId], references: [id])
  userId       String
  pointBalance Int // this can be negative or positive
  type         PointBalanceType
  startDate    DateTime         @default(now())
  endDate      DateTime // for substract type this should be null
}

model Coupon {
  id                 String @id @default(uuid())
  userId             String
  code               String @unique
  discountPercentage Int

  isUsed    Boolean  @default(false)
  startDate DateTime @default(now())
  endDate   DateTime

  event   Event  @relation(fields: [eventId], references: [id])
  eventId String

  user User @relation(fields: [userId], references: [id])

  transactions Transaction[]
}

model User {
  id             String   @id @default(uuid())
  name           String
  email          String   @unique
  password       String
  profilePicture String?
  role           Role
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  referralCode String  @unique // A special code that this user gets. They can share it with others to invite them to sign up.
  referrals    User[]  @relation("SignupReferral") // A list of users who signed up using this user's referral code.
  referredBy   User?   @relation("SignupReferral", fields: [referredById], references: [id]) // The user who invited this user to sign up (if they used a referral code).
  referredById String? // The ID of the user who invited this user (if a referral code was used).

  pointBalances   PointBalance[]
  organizedEvents Event[]        @relation("UserOrganizedEvents")
  transactions    Transaction[]
  reviews         Review[]
  coupons         Coupon[]
}

model EventCategory {
  id   String @id @default(uuid())
  name String @unique

  events Event[]
}

model Event {
  id          String   @id @default(uuid())
  name        String
  bannerUrl   String
  description String
  startDate   DateTime
  endDate     DateTime
  startTime   String
  endTime     String
  // totalCapacity Int // Should be managed on Event View
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  views       Int      @default(0)

  isEventOnline Boolean
  urlStreaming  String?
  placeName     String?
  placeCity     String?
  placeAddress  String?

  isPublished Boolean @default(false)

  organizer   User   @relation("UserOrganizedEvents", fields: [organizerId], references: [id])
  organizerId String

  category   EventCategory @relation(fields: [categoryId], references: [id])
  categoryId String

  tickets Ticket[]

  transactions Transaction[]
  reviews      Review[]
  coupons      Coupon[]
}

model Ticket {
  id            String     @id @default(uuid())
  type          TicketType
  name          String
  description   String
  initialAmount Int // seat available, dont change manually
  amount        Int
  startDate     DateTime
  endDate       DateTime
  startTime     String
  endTime       String
  price         Float?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  event   Event  @relation(fields: [eventId], references: [id])
  eventId String

  transactions Transaction[]
}

model Transaction {
  id             String            @id @default(uuid())
  status         TransactionStatus
  ticketQuantity Int
  totalPrice     Float
  paymentProof   String?
  createdAt      DateTime          @default(now())
  expiredAt      DateTime

  event   Event  @relation(fields: [eventId], references: [id])
  eventId String

  buyer   User   @relation(fields: [buyerId], references: [id])
  buyerId String

  ticket   Ticket @relation(fields: [ticketId], references: [id])
  ticketId String

  usedPoints Int     @default(0)
  coupon     Coupon? @relation(fields: [couponId], references: [id])
  couponId   String?
}

model Review {
  id        String   @id @default(uuid())
  rating    Int      @default(0) // check constraint to max of 5 on migration // value 0 mean user dont give rating;
  comment   String
  createdAt DateTime @default(now())

  event   Event  @relation(fields: [eventId], references: [id])
  eventId String

  customer   User   @relation(fields: [customerId], references: [id]) // user who review the event
  customerId String
}

enum TransactionStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  COMPLETED
  CANCELLED
}

enum Role {
  CUSTOMER
  ORGANIZER
}

enum PointBalanceType {
  ADD
  SUBSTRACT
}

enum TicketType {
  FREE
  PAID
}

// create manual view on migration. Dont update this manually on app
view RecordOrganizerAverageRating {
  organizerId   String @unique // this will be user id with role Organizer only
  averageRating Float // calculated from average all review rating for the event ever created for this organizer
}

// create manual view on migration. Dont update this manually on app
view RecordEventInfo {
  eventId          String @unique // this will be event id
  totalView        Int
  ticketTotal      Int // can be interpreted as total seat
  ticketRemaining  Int // can be interpreted as remaining seat
  totalIncome      Float
  totalTransaction Int
}

view RecordUserPointBalance {
  userId       String @unique
  pointBalance Int // active point balance
}
